# Trading Room SaaS - Enterprise Architecture Blueprint

## Version 1.0.0 | Google L7-L8 Enterprise Grade

---

## 1. High-Level Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              TRADING ROOM SAAS PLATFORM                                  │
│                         Multi-Tenant, Ultra-Low Latency WebRTC                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    CLIENT LAYER                                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │
│  │   React Web     │  │   Mobile Web    │  │   Desktop App   │  │   Admin Panel   │    │
│  │   Application   │  │   (PWA Ready)   │  │   (Electron)    │  │   Dashboard     │    │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘    │
│           │                    │                    │                    │              │
│           └────────────────────┴────────────────────┴────────────────────┘              │
│                                         │                                                │
│                              ┌──────────▼──────────┐                                    │
│                              │   Cloudflare CDN    │                                    │
│                              │   + DNS + WAF       │                                    │
│                              └──────────┬──────────┘                                    │
└─────────────────────────────────────────┼───────────────────────────────────────────────┘
                                          │
┌─────────────────────────────────────────┼───────────────────────────────────────────────┐
│                              GATEWAY LAYER                                               │
│                                         │                                                │
│  ┌──────────────────────────────────────┼──────────────────────────────────────────┐    │
│  │                         AWS ALB / Hetzner LB                                     │    │
│  │                    (Optional - for horizontal scaling)                           │    │
│  └──────────────────────────────────────┬──────────────────────────────────────────┘    │
│                                         │                                                │
│           ┌─────────────────────────────┼─────────────────────────────┐                 │
│           │                             │                             │                 │
│  ┌────────▼────────┐          ┌────────▼────────┐          ┌────────▼────────┐        │
│  │  Laravel 12     │          │  Node.js        │          │  Mediasoup      │        │
│  │  SaaS API       │          │  Signaling      │          │  SFU Cluster    │        │
│  │  (Port 8000)    │          │  (Port 3000)    │          │  (Ports 10000+) │        │
│  └────────┬────────┘          └────────┬────────┘          └────────┬────────┘        │
│           │                             │                             │                 │
└───────────┼─────────────────────────────┼─────────────────────────────┼─────────────────┘
            │                             │                             │
┌───────────┼─────────────────────────────┼─────────────────────────────┼─────────────────┐
│           │              SERVICE LAYER  │                             │                 │
│           │                             │                             │                 │
│  ┌────────▼────────┐          ┌────────▼────────┐          ┌────────▼────────┐        │
│  │  Redis          │          │  Supabase       │          │  Coturn         │        │
│  │  Cache/Queue    │◄────────►│  Realtime       │          │  TURN/STUN      │        │
│  │  (Port 6379)    │          │  Presence       │          │  (Port 3478)    │        │
│  └────────┬────────┘          └────────┬────────┘          └─────────────────┘        │
│           │                             │                                               │
│  ┌────────▼─────────────────────────────▼────────┐                                     │
│  │              Supabase PostgreSQL               │                                     │
│  │         (Multi-tenant with RLS)                │                                     │
│  └────────────────────────────────────────────────┘                                     │
│                                                                                          │
│  ┌────────────────────────────────────────────────┐                                     │
│  │           Cloudflare R2 Storage                │                                     │
│  │    (Files, Recordings, Notes, Uploads)         │                                     │
│  └────────────────────────────────────────────────┘                                     │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              INFRASTRUCTURE LAYER                                        │
│                                                                                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │
│  │  Hetzner CPX41  │  │  Hetzner CX22   │  │  Hetzner CX22   │  │  Hetzner CX22   │    │
│  │  SFU Server     │  │  TURN Server    │  │  Signaling      │  │  Laravel API    │    │
│  │  8 vCPU/16GB    │  │  2 vCPU/4GB     │  │  2 vCPU/4GB     │  │  2 vCPU/4GB     │    │
│  │  $34/mo         │  │  $6/mo          │  │  $6/mo          │  │  $6/mo          │    │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘    │
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│  │                         GitHub Actions CI/CD Pipeline                            │    │
│  │                    Docker Registry → Deploy → Health Check                       │    │
│  └─────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. WebRTC Media Flow Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           WEBRTC MEDIA FLOW - SFU TOPOLOGY                              │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────────────────────┐
                    │           HOST/BROADCASTER               │
                    │  ┌─────────────────────────────────────┐ │
                    │  │  Camera  │  Microphone  │  Screen   │ │
                    │  └─────┬────┴──────┬───────┴─────┬─────┘ │
                    │        │           │             │       │
                    │  ┌─────▼───────────▼─────────────▼─────┐ │
                    │  │         MediaStream API              │ │
                    │  │    (getUserMedia/getDisplayMedia)    │ │
                    │  └─────────────────┬───────────────────┘ │
                    │                    │                     │
                    │  ┌─────────────────▼───────────────────┐ │
                    │  │      mediasoup-client Producer       │ │
                    │  │  ┌─────────┐ ┌─────────┐ ┌────────┐ │ │
                    │  │  │ Video   │ │ Audio   │ │ Screen │ │ │
                    │  │  │Producer │ │Producer │ │Producer│ │ │
                    │  │  └────┬────┘ └────┬────┘ └───┬────┘ │ │
                    │  └───────┼───────────┼──────────┼──────┘ │
                    └──────────┼───────────┼──────────┼────────┘
                               │           │          │
                               │   SRTP/DTLS/ICE     │
                               │           │          │
┌──────────────────────────────┼───────────┼──────────┼────────────────────────────────────┐
│                              │           │          │                                     │
│  ┌───────────────────────────▼───────────▼──────────▼───────────────────────────────┐   │
│  │                          MEDIASOUP SFU CLUSTER                                    │   │
│  │                                                                                   │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐ │   │
│  │  │                           SFU Node Manager                                   │ │   │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │ │   │
│  │  │  │ Worker 0     │  │ Worker 1     │  │ Worker 2     │  │ Worker N     │    │ │   │
│  │  │  │ CPU Core 0   │  │ CPU Core 1   │  │ CPU Core 2   │  │ CPU Core N   │    │ │   │
│  │  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘    │ │   │
│  │  │         │                 │                 │                 │            │ │   │
│  │  │  ┌──────▼───────┐  ┌──────▼───────┐  ┌──────▼───────┐  ┌──────▼───────┐    │ │   │
│  │  │  │ Router       │  │ Router       │  │ Router       │  │ Router       │    │ │   │
│  │  │  │ Room A       │  │ Room B       │  │ Room C       │  │ Room D       │    │ │   │
│  │  │  │ Tenant X     │  │ Tenant Y     │  │ Tenant X     │  │ Tenant Z     │    │ │   │
│  │  │  └──────┬───────┘  └──────────────┘  └──────────────┘  └──────────────┘    │ │   │
│  │  │         │                                                                   │ │   │
│  │  │  ┌──────▼─────────────────────────────────────────────────────────────┐    │ │   │
│  │  │  │                    Transport Layer (per participant)                │    │ │   │
│  │  │  │  ┌────────────────────┐        ┌────────────────────┐              │    │ │   │
│  │  │  │  │ WebRtcTransport    │        │ WebRtcTransport    │              │    │ │   │
│  │  │  │  │ (Send - Host)      │        │ (Recv - Viewers)   │              │    │ │   │
│  │  │  │  │ ICE + DTLS + SRTP  │        │ ICE + DTLS + SRTP  │              │    │ │   │
│  │  │  │  └────────────────────┘        └────────────────────┘              │    │ │   │
│  │  │  └────────────────────────────────────────────────────────────────────┘    │ │   │
│  │  └─────────────────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                                   │   │
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐ │   │
│  │  │                        Simulcast Configuration                              │ │   │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                      │ │   │
│  │  │  │ Layer 0      │  │ Layer 1      │  │ Layer 2      │                      │ │   │
│  │  │  │ 1080p@30fps  │  │ 720p@30fps   │  │ 360p@15fps   │                      │ │   │
│  │  │  │ 2500 kbps    │  │ 1000 kbps    │  │ 300 kbps     │                      │ │   │
│  │  │  └──────────────┘  └──────────────┘  └──────────────┘                      │ │   │
│  │  └─────────────────────────────────────────────────────────────────────────────┘ │   │
│  └───────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
└──────────────────────────────────────────────────────────────────────────────────────────┘
                               │           │          │
                               │   SRTP/DTLS/ICE     │
                               │           │          │
          ┌────────────────────┼───────────┼──────────┼────────────────────┐
          │                    │           │          │                    │
┌─────────▼─────────┐ ┌───────▼───────┐ ┌─▼────────┐ ┌▼─────────────────┐
│     VIEWER 1      │ │   VIEWER 2    │ │ VIEWER 3 │ │    VIEWER N      │
│  ┌─────────────┐  │ │ ┌───────────┐ │ │┌────────┐│ │ ┌─────────────┐  │
│  │ Consumer    │  │ │ │ Consumer  │ │ ││Consumer││ │ │ Consumer    │  │
│  │ Video+Audio │  │ │ │Video+Audio│ │ ││V+A     ││ │ │ Video+Audio │  │
│  └─────────────┘  │ │ └───────────┘ │ │└────────┘│ │ └─────────────┘  │
└───────────────────┘ └───────────────┘ └──────────┘ └─────────────────┘
```

---

## 3. Multi-Tenant Data Isolation Model

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                         MULTI-TENANT ISOLATION ARCHITECTURE                              │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              TENANT HIERARCHY                                            │
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│  │                              ORGANIZATION (Tenant)                               │    │
│  │                           ID: org_abc123 | Plan: Enterprise                      │    │
│  │  ┌───────────────────────────────────────────────────────────────────────────┐  │    │
│  │  │                              WORKSPACES                                    │  │    │
│  │  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │  │    │
│  │  │  │  Workspace A    │  │  Workspace B    │  │  Workspace C    │           │  │    │
│  │  │  │  "Day Trading"  │  │  "Forex Desk"   │  │  "Crypto Team"  │           │  │    │
│  │  │  │  ┌───────────┐  │  │  ┌───────────┐  │  │  ┌───────────┐  │           │  │    │
│  │  │  │  │  Room 1   │  │  │  │  Room 1   │  │  │  │  Room 1   │  │           │  │    │
│  │  │  │  │  Room 2   │  │  │  │  Room 2   │  │  │  │  Room 2   │  │           │  │    │
│  │  │  │  │  Room 3   │  │  │  │  Room 3   │  │  │  │  Room 3   │  │           │  │    │
│  │  │  │  └───────────┘  │  │  └───────────┘  │  │  └───────────┘  │           │  │    │
│  │  │  └─────────────────┘  └─────────────────┘  └─────────────────┘           │  │    │
│  │  └───────────────────────────────────────────────────────────────────────────┘  │    │
│  │                                                                                  │    │
│  │  ┌───────────────────────────────────────────────────────────────────────────┐  │    │
│  │  │                              MEMBERS                                       │  │    │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │  │    │
│  │  │  │   Owner     │  │   Admin     │  │   Host      │  │   Viewer    │       │  │    │
│  │  │  │ (1 per org) │  │ (unlimited) │  │ (per plan)  │  │ (per plan)  │       │  │    │
│  │  │  │ ALL perms   │  │ Manage all  │  │ Stream+Mod  │  │ View only   │       │  │    │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │  │    │
│  │  └───────────────────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           ROW LEVEL SECURITY (RLS) POLICIES                             │
│                                                                                          │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │  POLICY: tenant_isolation                                                         │  │
│  │  ────────────────────────────────────────────────────────────────────────────────│  │
│  │  CREATE POLICY tenant_isolation ON rooms                                          │  │
│  │  FOR ALL                                                                          │  │
│  │  USING (                                                                          │  │
│  │    organization_id = (                                                            │  │
│  │      SELECT organization_id FROM organization_members                             │  │
│  │      WHERE user_id = auth.uid()                                                   │  │
│  │    )                                                                              │  │
│  │  );                                                                               │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │  POLICY: workspace_access                                                         │  │
│  │  ────────────────────────────────────────────────────────────────────────────────│  │
│  │  CREATE POLICY workspace_access ON workspace_members                              │  │
│  │  FOR SELECT                                                                       │  │
│  │  USING (                                                                          │  │
│  │    user_id = auth.uid()                                                           │  │
│  │    OR                                                                             │  │
│  │    workspace_id IN (                                                              │  │
│  │      SELECT workspace_id FROM workspace_members WHERE user_id = auth.uid()        │  │
│  │    )                                                                              │  │
│  │  );                                                                               │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              ROLE PERMISSIONS MATRIX                                     │
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│  │  Permission              │ Owner │ Admin │ Host │ Co-Host │ Moderator │ Viewer │    │
│  │  ────────────────────────┼───────┼───────┼──────┼─────────┼───────────┼────────│    │
│  │  Manage Billing          │   ✓   │   ✗   │  ✗   │    ✗    │     ✗     │   ✗    │    │
│  │  Manage Organization     │   ✓   │   ✓   │  ✗   │    ✗    │     ✗     │   ✗    │    │
│  │  Create Workspaces       │   ✓   │   ✓   │  ✗   │    ✗    │     ✗     │   ✗    │    │
│  │  Create Rooms            │   ✓   │   ✓   │  ✓   │    ✗    │     ✗     │   ✗    │    │
│  │  Start Streaming         │   ✓   │   ✓   │  ✓   │    ✓    │     ✗     │   ✗    │    │
│  │  Share Screen            │   ✓   │   ✓   │  ✓   │    ✓    │     ✗     │   ✗    │    │
│  │  Mute Participants       │   ✓   │   ✓   │  ✓   │    ✓    │     ✓     │   ✗    │    │
│  │  Remove Participants     │   ✓   │   ✓   │  ✓   │    ✓    │     ✓     │   ✗    │    │
│  │  Send Chat Messages      │   ✓   │   ✓   │  ✓   │    ✓    │     ✓     │   ✓    │    │
│  │  View Stream             │   ✓   │   ✓   │  ✓   │    ✓    │     ✓     │   ✓    │    │
│  │  Upload Files            │   ✓   │   ✓   │  ✓   │    ✓    │     ✗     │   ✗    │    │
│  │  View Analytics          │   ✓   │   ✓   │  ✓   │    ✗    │     ✗     │   ✗    │    │
│  │  Manage Integrations     │   ✓   │   ✓   │  ✗   │    ✗    │     ✗     │   ✗    │    │
│  └─────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Subscription Plans & Limits

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              STRIPE BILLING PLANS                                        │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┬─────────────────┬─────────────────┬─────────────────┐
│     STARTER     │   PROFESSIONAL  │    BUSINESS     │   ENTERPRISE    │
│    $49/month    │   $149/month    │   $449/month    │   Custom/month  │
├─────────────────┼─────────────────┼─────────────────┼─────────────────┤
│                 │                 │                 │                 │
│ Workspaces: 1   │ Workspaces: 3   │ Workspaces: 10  │ Workspaces: ∞   │
│ Rooms: 3        │ Rooms: 10       │ Rooms: 50       │ Rooms: ∞        │
│ Hosts: 1        │ Hosts: 3        │ Hosts: 10       │ Hosts: ∞        │
│ Viewers: 50     │ Viewers: 200    │ Viewers: 1000   │ Viewers: ∞      │
│ Storage: 5GB    │ Storage: 25GB   │ Storage: 100GB  │ Storage: 1TB    │
│ Recording: ✗    │ Recording: ✓    │ Recording: ✓    │ Recording: ✓    │
│ Analytics: Basic│ Analytics: Adv  │ Analytics: Full │ Analytics: Full │
│ Support: Email  │ Support: Chat   │ Support: Phone  │ Support: Dedic  │
│ SLA: 99.5%      │ SLA: 99.9%      │ SLA: 99.95%     │ SLA: 99.99%     │
│ API Access: ✗   │ API Access: ✓   │ API Access: ✓   │ API Access: ✓   │
│ Custom Brand: ✗ │ Custom Brand: ✗ │ Custom Brand: ✓ │ Custom Brand: ✓ │
│ SSO: ✗          │ SSO: ✗          │ SSO: ✓          │ SSO: ✓          │
│ Audit Logs: ✗   │ Audit Logs: ✗   │ Audit Logs: ✓   │ Audit Logs: ✓   │
│                 │                 │                 │                 │
└─────────────────┴─────────────────┴─────────────────┴─────────────────┘
```

---

## 5. Signaling Server Event Contracts

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                         WEBSOCKET SIGNALING PROTOCOL                                     │
│                              Version: 1.0.0                                              │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ CLIENT → SERVER EVENTS                                                                   │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│ ┌─────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ EVENT: authenticate                                                                 │ │
│ │ PURPOSE: Authenticate client with Supabase JWT                                      │ │
│ │ PAYLOAD:                                                                            │ │
│ │ {                                                                                   │ │
│ │   "event": "authenticate",                                                          │ │
│ │   "data": {                                                                         │ │
│ │     "token": "eyJhbGciOiJIUzI1NiIs...",                                            │ │
│ │     "organizationId": "org_abc123",                                                 │ │
│ │     "deviceInfo": {                                                                 │ │
│ │       "userAgent": "...",                                                           │ │
│ │       "platform": "web"                                                             │ │
│ │     }                                                                               │ │
│ │   }                                                                                 │ │
│ │ }                                                                                   │ │
│ └─────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│ ┌─────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ EVENT: join-room                                                                    │ │
│ │ PURPOSE: Join a specific room                                                       │ │
│ │ PAYLOAD:                                                                            │ │
│ │ {                                                                                   │ │
│ │   "event": "join-room",                                                             │ │
│ │   "data": {                                                                         │ │
│ │     "roomId": "room_xyz789",                                                        │ │
│ │     "role": "host|co-host|viewer",                                                  │ │
│ │     "displayName": "John Trader",                                                   │ │
│ │     "rtpCapabilities": { ... }                                                      │ │
│ │   }                                                                                 │ │
│ │ }                                                                                   │ │
│ └─────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│ ┌─────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ EVENT: create-transport                                                             │ │
│ │ PURPOSE: Create WebRTC transport for sending/receiving media                        │ │
│ │ PAYLOAD:                                                                            │ │
│ │ {                                                                                   │ │
│ │   "event": "create-transport",                                                      │ │
│ │   "data": {                                                                         │ │
│ │     "roomId": "room_xyz789",                                                        │ │
│ │     "direction": "send|recv",                                                       │ │
│ │     "sctpCapabilities": { ... }                                                     │ │
│ │   }                                                                                 │ │
│ │ }                                                                                   │ │
│ └─────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│ ┌─────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ EVENT: connect-transport                                                            │ │
│ │ PURPOSE: Complete ICE/DTLS handshake                                                │ │
│ │ PAYLOAD:                                                                            │ │
│ │ {                                                                                   │ │
│ │   "event": "connect-transport",                                                     │ │
│ │   "data": {                                                                         │ │
│ │     "transportId": "transport_abc",                                                 │ │
│ │     "dtlsParameters": {                                                             │ │
│ │       "role": "client",                                                             │ │
│ │       "fingerprints": [{ "algorithm": "sha-256", "value": "..." }]                 │ │
│ │     }                                                                               │ │
│ │   }                                                                                 │ │
│ │ }                                                                                   │ │
│ └─────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│ ┌─────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ EVENT: produce                                                                      │ │
│ │ PURPOSE: Start producing media (host/co-host only)                                  │ │
│ │ PAYLOAD:                                                                            │ │
│ │ {                                                                                   │ │
│ │   "event": "produce",                                                               │ │
│ │   "data": {                                                                         │ │
│ │     "transportId": "transport_abc",                                                 │ │
│ │     "kind": "video|audio",                                                          │ │
│ │     "rtpParameters": { ... },                                                       │ │
│ │     "appData": {                                                                    │ │
│ │       "source": "camera|microphone|screen"                                          │ │
│ │     }                                                                               │ │
│ │   }                                                                                 │ │
│ │ }                                                                                   │ │
│ └─────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│ ┌─────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ EVENT: consume                                                                      │ │
│ │ PURPOSE: Request to consume a producer's media                                      │ │
│ │ PAYLOAD:                                                                            │ │
│ │ {                                                                                   │ │
│ │   "event": "consume",                                                               │ │
│ │   "data": {                                                                         │ │
│ │     "producerId": "producer_xyz",                                                   │ │
│ │     "rtpCapabilities": { ... }                                                      │ │
│ │   }                                                                                 │ │
│ │ }                                                                                   │ │
│ └─────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│ ┌─────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ EVENT: set-preferred-layers                                                         │ │
│ │ PURPOSE: Request specific simulcast layer                                           │ │
│ │ PAYLOAD:                                                                            │ │
│ │ {                                                                                   │ │
│ │   "event": "set-preferred-layers",                                                  │ │
│ │   "data": {                                                                         │ │
│ │     "consumerId": "consumer_abc",                                                   │ │
│ │     "spatialLayer": 2,                                                              │ │
│ │     "temporalLayer": 2                                                              │ │
│ │   }                                                                                 │ │
│ │ }                                                                                   │ │
│ └─────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ SERVER → CLIENT EVENTS                                                                   │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│ ┌─────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ EVENT: authenticated                                                                │ │
│ │ PAYLOAD:                                                                            │ │
│ │ {                                                                                   │ │
│ │   "event": "authenticated",                                                         │ │
│ │   "data": {                                                                         │ │
│ │     "userId": "user_123",                                                           │ │
│ │     "organizationId": "org_abc123",                                                 │ │
│ │     "permissions": ["stream", "moderate", "view"],                                  │ │
│ │     "limits": {                                                                     │ │
│ │       "maxRooms": 10,                                                               │ │
│ │       "maxViewers": 200                                                             │ │
│ │     }                                                                               │ │
│ │   }                                                                                 │ │
│ │ }                                                                                   │ │
│ └─────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│ ┌─────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ EVENT: room-joined                                                                  │ │
│ │ PAYLOAD:                                                                            │ │
│ │ {                                                                                   │ │
│ │   "event": "room-joined",                                                           │ │
│ │   "data": {                                                                         │ │
│ │     "roomId": "room_xyz789",                                                        │ │
│ │     "routerRtpCapabilities": { ... },                                               │ │
│ │     "participants": [                                                               │ │
│ │       { "userId": "...", "displayName": "...", "role": "host", "producers": [...] } │ │
│ │     ],                                                                              │ │
│ │     "sfuNode": "sfu-1.trading-room.io"                                             │ │
│ │   }                                                                                 │ │
│ │ }                                                                                   │ │
│ └─────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│ ┌─────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ EVENT: transport-created                                                            │ │
│ │ PAYLOAD:                                                                            │ │
│ │ {                                                                                   │ │
│ │   "event": "transport-created",                                                     │ │
│ │   "data": {                                                                         │ │
│ │     "transportId": "transport_abc",                                                 │ │
│ │     "iceParameters": { "usernameFragment": "...", "password": "..." },             │ │
│ │     "iceCandidates": [{ "foundation": "...", "ip": "...", "port": ... }],          │ │
│ │     "dtlsParameters": { ... },                                                      │ │
│ │     "sctpParameters": { ... }                                                       │ │
│ │   }                                                                                 │ │
│ │ }                                                                                   │ │
│ └─────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│ ┌─────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ EVENT: new-producer                                                                 │ │
│ │ PURPOSE: Notify viewers of new media producer                                       │ │
│ │ PAYLOAD:                                                                            │ │
│ │ {                                                                                   │ │
│ │   "event": "new-producer",                                                          │ │
│ │   "data": {                                                                         │ │
│ │     "producerId": "producer_xyz",                                                   │ │
│ │     "producerUserId": "user_456",                                                   │ │
│ │     "kind": "video",                                                                │ │
│ │     "appData": { "source": "camera", "displayName": "John Trader" }                │ │
│ │   }                                                                                 │ │
│ │ }                                                                                   │ │
│ └─────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│ ┌─────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ EVENT: consumer-created                                                             │ │
│ │ PAYLOAD:                                                                            │ │
│ │ {                                                                                   │ │
│ │   "event": "consumer-created",                                                      │ │
│ │   "data": {                                                                         │ │
│ │     "consumerId": "consumer_abc",                                                   │ │
│ │     "producerId": "producer_xyz",                                                   │ │
│ │     "kind": "video",                                                                │ │
│ │     "rtpParameters": { ... },                                                       │ │
│ │     "appData": { ... }                                                              │ │
│ │   }                                                                                 │ │
│ │ }                                                                                   │ │
│ └─────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
│ ┌─────────────────────────────────────────────────────────────────────────────────────┐ │
│ │ EVENT: participant-joined / participant-left                                        │ │
│ │ EVENT: producer-closed / consumer-closed                                            │ │
│ │ EVENT: room-closed                                                                  │ │
│ │ EVENT: error                                                                        │ │
│ └─────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Security Model

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              SECURITY ARCHITECTURE                                       │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           AUTHENTICATION FLOW                                            │
│                                                                                          │
│   ┌─────────┐    ┌──────────────┐    ┌─────────────┐    ┌──────────────┐               │
│   │ Client  │───►│ Supabase Auth│───►│ JWT Token   │───►│ API/Signaling│               │
│   │         │    │ (OAuth/Email)│    │ (RS256)     │    │ Verification │               │
│   └─────────┘    └──────────────┘    └─────────────┘    └──────────────┘               │
│                                                                                          │
│   JWT Claims:                                                                            │
│   {                                                                                      │
│     "sub": "user_uuid",                                                                  │
│     "email": "user@example.com",                                                         │
│     "role": "authenticated",                                                             │
│     "app_metadata": {                                                                    │
│       "organization_id": "org_abc123",                                                   │
│       "organization_role": "admin"                                                       │
│     },                                                                                   │
│     "exp": 1234567890                                                                    │
│   }                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           ENCRYPTION LAYERS                                              │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │ Layer 1: TLS 1.3 (Transport)                                                    │   │
│   │ - All HTTP/WebSocket connections                                                │   │
│   │ - Certificate: Cloudflare Edge / Let's Encrypt                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │ Layer 2: DTLS 1.2 (WebRTC)                                                      │   │
│   │ - Media transport encryption                                                    │   │
│   │ - SRTP key derivation                                                           │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │ Layer 3: SRTP (Media)                                                           │   │
│   │ - AES-128-CM encryption                                                         │   │
│   │ - HMAC-SHA1 authentication                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │ Layer 4: Application (Data at Rest)                                             │   │
│   │ - AES-256-GCM for sensitive data                                                │   │
│   │ - Supabase Vault for secrets                                                    │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           RATE LIMITING                                                  │
│                                                                                          │
│   ┌───────────────────────────┬──────────────────────────────────────────────────────┐  │
│   │ Endpoint                  │ Limits                                               │  │
│   ├───────────────────────────┼──────────────────────────────────────────────────────┤  │
│   │ Authentication            │ 5 requests/minute per IP                             │  │
│   │ API Endpoints             │ 100 requests/minute per user                         │  │
│   │ WebSocket Connection      │ 10 connections/minute per user                       │  │
│   │ Media Transport Creation  │ 20/minute per room                                   │  │
│   │ File Upload               │ 10 uploads/hour per user                             │  │
│   └───────────────────────────┴──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Observability Stack

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              OBSERVABILITY ARCHITECTURE                                  │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │
│  │   Laravel API   │  │   Node.js       │  │   Mediasoup     │  │   PostgreSQL    │    │
│  │                 │  │   Signaling     │  │   SFU           │  │                 │    │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘    │
│           │                    │                    │                    │              │
│           │         ┌──────────┴──────────┐        │                    │              │
│           │         │ Structured Logging  │        │                    │              │
│           │         │ (JSON format)       │        │                    │              │
│           │         └──────────┬──────────┘        │                    │              │
│           │                    │                    │                    │              │
│  ┌────────▼────────────────────▼────────────────────▼────────────────────▼────────┐    │
│  │                           Vector / Fluentd                                      │    │
│  │                      (Log aggregation & routing)                                │    │
│  └────────────────────────────────┬───────────────────────────────────────────────┘    │
│                                   │                                                     │
│           ┌───────────────────────┼───────────────────────┐                            │
│           │                       │                       │                            │
│  ┌────────▼────────┐    ┌────────▼────────┐    ┌────────▼────────┐                    │
│  │   Loki          │    │   Prometheus    │    │   Grafana       │                    │
│  │   (Logs)        │    │   (Metrics)     │    │   (Dashboards)  │                    │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘                    │
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│  │                          KEY METRICS                                             │    │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                  │    │
│  │  │ WebRTC Metrics  │  │ Business Metrics│  │ Infra Metrics   │                  │    │
│  │  │ - RTT latency   │  │ - Active rooms  │  │ - CPU usage     │                  │    │
│  │  │ - Packet loss   │  │ - Concurrent    │  │ - Memory        │                  │    │
│  │  │ - Jitter        │  │   viewers       │  │ - Disk I/O      │                  │    │
│  │  │ - Bitrate       │  │ - Stream hours  │  │ - Network       │                  │    │
│  │  │ - Frame rate    │  │ - Subscriptions │  │ - Error rates   │                  │    │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘                  │    │
│  └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│  │                          ALERTING RULES                                          │    │
│  │  - P0: SFU node down → PagerDuty immediate                                       │    │
│  │  - P0: Authentication service failure → PagerDuty immediate                      │    │
│  │  - P1: Latency > 200ms → Slack + Email                                          │    │
│  │  - P1: Packet loss > 5% → Slack + Email                                         │    │
│  │  - P2: CPU > 80% for 5min → Slack                                               │    │
│  │  - P2: Room capacity > 90% → Slack                                              │    │
│  └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Deployment Pipeline

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              CI/CD PIPELINE                                              │
│                           GitHub Actions Workflow                                        │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                          │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐              │
│  │  Push   │───►│  Lint   │───►│  Test   │───►│  Build  │───►│  Scan   │              │
│  │         │    │         │    │         │    │         │    │ (Trivy) │              │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘    └────┬────┘              │
│                                                                    │                    │
│                                                          ┌────────▼────────┐           │
│                                                          │ Docker Registry │           │
│                                                          │ (GHCR/DockerHub)│           │
│                                                          └────────┬────────┘           │
│                                                                   │                    │
│                    ┌──────────────────────────────────────────────┤                    │
│                    │                                              │                    │
│           ┌────────▼────────┐                           ┌────────▼────────┐           │
│           │    Staging      │                           │   Production    │           │
│           │  (auto-deploy)  │                           │ (manual approve)│           │
│           └────────┬────────┘                           └────────┬────────┘           │
│                    │                                              │                    │
│           ┌────────▼────────┐                           ┌────────▼────────┐           │
│           │  Smoke Tests    │                           │  Blue/Green     │           │
│           │  E2E Tests      │                           │  Deployment     │           │
│           └─────────────────┘                           └─────────────────┘           │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. Scaling Strategy

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              HORIZONTAL SCALING STRATEGY                                 │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ COMPONENT         │ SCALING TRIGGER           │ SCALE ACTION                            │
├───────────────────┼───────────────────────────┼─────────────────────────────────────────┤
│ Laravel API       │ CPU > 70% for 3min        │ Add instance (max 10)                   │
│                   │ Response time > 500ms     │ Add instance                            │
├───────────────────┼───────────────────────────┼─────────────────────────────────────────┤
│ Signaling Server  │ Connections > 5000        │ Add instance (max 5)                    │
│                   │ Memory > 80%              │ Add instance                            │
├───────────────────┼───────────────────────────┼─────────────────────────────────────────┤
│ Mediasoup SFU     │ CPU > 60% for 2min        │ Add worker                              │
│                   │ Rooms > 50/node           │ Add node                                │
│                   │ Bandwidth > 8Gbps         │ Add node                                │
├───────────────────┼───────────────────────────┼─────────────────────────────────────────┤
│ Redis             │ Memory > 80%              │ Scale up instance                       │
│                   │ Connections > 10000       │ Add replica                             │
├───────────────────┼───────────────────────────┼─────────────────────────────────────────┤
│ PostgreSQL        │ Connections > 500         │ Add read replica                        │
│                   │ CPU > 80%                 │ Scale up instance                       │
└───────────────────┴───────────────────────────┴─────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           SFU CLUSTER ORCHESTRATION                                      │
│                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                          Load Balancer (SFU Router)                             │   │
│   │                                                                                 │   │
│   │   Algorithm: Least-Loaded + Geographic Affinity                                 │   │
│   │                                                                                 │   │
│   │   Selection Criteria:                                                           │   │
│   │   1. CPU utilization < 60%                                                      │   │
│   │   2. Memory utilization < 70%                                                   │   │
│   │   3. Active rooms < 50                                                          │   │
│   │   4. Bandwidth headroom > 2Gbps                                                 │   │
│   │   5. Geographic proximity to participants                                       │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                   │
│   │  SFU-EU-1   │  │  SFU-EU-2   │  │  SFU-US-1   │  │  SFU-AS-1   │                   │
│   │  Frankfurt  │  │  Amsterdam  │  │  Ashburn    │  │  Singapore  │                   │
│   │  Load: 45%  │  │  Load: 62%  │  │  Load: 38%  │  │  Load: 55%  │                   │
│   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘                   │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```
