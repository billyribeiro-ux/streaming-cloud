;; ==============================================================================
;; PgBouncer Configuration - Connection Pooling for PostgreSQL
;; ==============================================================================
;; Provides connection pooling to reduce PostgreSQL connection overhead
;; Expected improvement: 30-50% reduction in connection time
;; ==============================================================================

[databases]
;; Database connection strings
;; Format: dbname = host=hostname port=5432 dbname=dbname user=username password=password
tradingroom = host=${SUPABASE_DB_HOST} port=5432 dbname=${SUPABASE_DB_NAME} user=${SUPABASE_DB_USER} password=${SUPABASE_DB_PASSWORD}

[pgbouncer]
;; ==============================================================================
;; Pool Mode
;; ==============================================================================
;; session: Server connection is released when client disconnects (default)
;; transaction: Server connection is released when transaction finishes
;; statement: Server connection is released after each statement
;;
;; Use 'transaction' for best performance with Laravel
pool_mode = transaction

;; ==============================================================================
;; Connection Limits
;; ==============================================================================
;; max_client_conn: Maximum number of client connections
max_client_conn = 1000

;; default_pool_size: Number of server connections per user/database pair
default_pool_size = 20

;; min_pool_size: Minimum server connections to keep open
min_pool_size = 5

;; reserve_pool_size: Reserve connections for new clients when pool is full
reserve_pool_size = 5

;; max_db_connections: Maximum connections per database
max_db_connections = 100

;; max_user_connections: Maximum connections per user
max_user_connections = 100

;; ==============================================================================
;; Timeouts
;; ==============================================================================
;; server_idle_timeout: Close server connection if idle for this long (seconds)
server_idle_timeout = 600

;; server_lifetime: Close and reconnect server after this time (seconds)
;; Prevents connection leaks
server_lifetime = 3600

;; server_connect_timeout: Timeout for connecting to PostgreSQL (seconds)
server_connect_timeout = 15

;; query_timeout: Maximum query execution time (seconds)
;; 0 = disabled
query_timeout = 0

;; query_wait_timeout: Maximum time queries wait for connection (seconds)
query_wait_timeout = 120

;; client_idle_timeout: Close client connection if idle (seconds)
client_idle_timeout = 0

;; ==============================================================================
;; Networking
;; ==============================================================================
;; Listen address
listen_addr = 0.0.0.0
listen_port = 6432

;; Unix socket
unix_socket_dir = /var/run/pgbouncer

;; ==============================================================================
;; Authentication
;; ==============================================================================
;; auth_type: Authentication method
;; Options: pam, hba, cert, md5, scram-sha-256, plain, trust, any
auth_type = md5

;; auth_file: User authentication file
auth_file = /etc/pgbouncer/userlist.txt

;; ==============================================================================
;; Logging
;; ==============================================================================
;; log_connections: Log successful connections
log_connections = 1

;; log_disconnections: Log disconnections
log_disconnections = 1

;; log_pooler_errors: Log pooler errors
log_pooler_errors = 1

;; log_stats: Periodically log statistics
stats_period = 60

;; verbose: Increase log verbosity
verbose = 0

;; ==============================================================================
;; Performance Tuning
;; ==============================================================================
;; server_reset_query: SQL to run when server connection is returned to pool
;; Use DISCARD ALL to reset session state
server_reset_query = DISCARD ALL

;; server_reset_query_always: Always run reset query
server_reset_query_always = 0

;; server_check_delay: How often to check server connections (seconds)
server_check_delay = 30

;; server_check_query: Query to check if server is alive
server_check_query = SELECT 1

;; server_fast_close: Use fast close for server connections
server_fast_close = 0

;; tcp_keepalive: Enable TCP keepalive
tcp_keepalive = 1
tcp_keepidle = 60
tcp_keepintvl = 10
tcp_keepcnt = 5

;; tcp_user_timeout: TCP connection timeout (milliseconds)
tcp_user_timeout = 0

;; ==============================================================================
;; Admin Console
;; ==============================================================================
;; Admin users can connect to special 'pgbouncer' database
admin_users = ${PGBOUNCER_ADMIN_USER}

;; stats_users: Users allowed to query statistics
stats_users = ${PGBOUNCER_STATS_USER}

;; ==============================================================================
;; Advanced Settings
;; ==============================================================================
;; ignore_startup_parameters: Parameters to ignore from client
ignore_startup_parameters = extra_float_digits

;; application_name_add_host: Add hostname to application_name
application_name_add_host = 1

;; pkt_buf: Packet buffer size (bytes)
pkt_buf = 4096

;; max_packet_size: Maximum packet size (bytes)
max_packet_size = 2147483647

;; sbuf_loopcnt: How many times to process data before sleep
sbuf_loopcnt = 5

;; so_reuseport: Enable SO_REUSEPORT socket option
so_reuseport = 1

;; ==============================================================================
;; Notes
;; ==============================================================================
;; - Set pool_mode=transaction for Laravel (session mode causes issues)
;; - Adjust default_pool_size based on your workload
;; - Monitor with: SHOW POOLS, SHOW STATS, SHOW SERVERS
;; - Access admin console: psql -p 6432 -U admin pgbouncer
;; ==============================================================================
